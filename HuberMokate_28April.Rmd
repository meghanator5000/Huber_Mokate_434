---
title: "HuberMokate_28April"
author: "Jane Huber & Meghan Mokate"
date: "4/28/2021"
output: html_document
---

The point of this document is to share our work with Alea/Prof Fusi.
Contains our work, not much more.

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse) 
library(rvest)
library(janitor)
library(tinytex)
library(haven) # may use for regression / regression line (may not)
library(splitstackshape) # for cSplit
library(knitr)
library(extrafont)
library(blscrapeR) # to gather and complete inflation-related calculations 
library(lubridate) # to help clean date representations
```

## Gather and clean original data

```{r gather-clean-productivity-data}

#Source: https://www.epi.org/productivity-pay-gap/
net_productivity_dataset <- read_csv("Data_HourlyCompensation_NetProd.csv")

net_productivity_dataset <- 
  net_productivity_dataset %>% 
  select(Year, `Net Productivity`) %>% 
  transmute(year = Year,
            net_productivity = `Net Productivity`)

```

```{r gather-clean-minimum-wage}
#Source: https://www.dol.gov/agencies/whd/minimum-wage/history/chart#fn4
min_wage_dataset <- read_csv("FederalMinimumWage.csv")

min_wage_dataset <- 
  min_wage_dataset %>% 
  transmute(year = as.numeric(format(as.Date(mdy(effective_date)), "%Y")),
            raw_min_wage = 
              as.numeric(str_replace_all(fed_min_wage, "\\$", "")))

# min_wage_dataset %>% 
#   complete(year)

# Transmute year, we have to do some work to parse out the year value
# Transmute raw_min_wage, we want to remove the $ sign.

# NOTE: At this point, the minimum wage dataset only contains years in which
# the minimum wage was adjusted by Congress. We will address this as we
# combine datasets.

```

Useful Q & A about what CPI is and how to interpret:
https://www.bls.gov/cpi/questions-and-answers.htm#Question_15
```{r gather-clean-cpi-data}

# Get "seriesId" from BLS website.This refers to the CPI for all items
# for urban consumers, which is considered the standard for economic
# analysis.
# 
# bls_seriesid <- "CUSR0000SA0"
# 
# # BLS API only allows for 10 years of data to be gathered at a time.
# # Therefore, calculate the number of iterations through a for loop
# # needed to capture all data.
# 
# num_decades <- round((2018 - 1948) / 10) + 1
# 
# # Set initial values for start and end year. In the for loop, we will update
# # these values after gathering the data.
# start_year <- 1948
# end_year <- 1957
# 
# 
# # Declare inflation_dataset in Global context, update in for-loop
# inflation_dataset
# 
# for (i in 1:num_decades) {
# 
#   if (i != 1) {
# 
#     start_year <- end_year + 1
#     end_year <- start_year + 9
# 
#     if (as.numeric(end_year) > 2018) {
#       #This is the final year that we want in the dataset.
#       end_year <- 2018
#     }
#   }
# 
#   print(start_year)
#   print(end_year)
# 
#   decade_dataset <- bls_api(seriesid = bls_seriesid,
#                        startyear = as.character(start_year),
#                        endyear = as.character(end_year),
#                        annualaverage=TRUE)
#   if (i != 1) {
#     inflation_dataset <- bind_rows(inflation_dataset, decade_dataset)
#   } else {
#     inflation_dataset <- decade_dataset
#   }
# }

# write_csv(inflation_dataset, "Inflation_Dataset")

inflation_dataset <- read_csv("Inflation_Dataset")

# The BLS provides us with monthly CPI values for every year since 1948. We 
# need to average these values to create an annual CPI value.

inflation_dataset <- 
  inflation_dataset %>% 
  group_by(year) %>% 
  summarize(annual_avg_cpi = mean(value))

# Note: In order to calculate inflation between two years, we will use the
# following formula (source: BLS):
#   inflation = ((SecondPeriodCPI - PreviousPeriodCPI) / PreviousPeriodCPI)

```

## Combine and Clean Data

```{r combine-datasets}

#First, combine inflation and min_wage datasets
main_dataset <- 
  left_join(inflation_dataset, min_wage_dataset, by = "year")
  

#Now, add in the net productivity
main_dataset <- 
  left_join(main_dataset, net_productivity_dataset, by = "year")

```

```{r tidy-main_dataset}

main_dataset <- 
  main_dataset %>% 
  fill(raw_min_wage, .direction = "down") 


# In 1948, the minimum wage was $.40. Since our current method of filling in NA
# values, relies on that value, 
main_dataset$raw_min_wage <- 
  replace_na(main_dataset$raw_min_wage,  0.4) #How can we get this to work 
# in the pipes?

```

```{r calculate-year-to-year-productivity-gains, warning=FALSE}

main_dataset$prod_multiplier <- vector("numeric", nrow(main_dataset))

for (i in 1:nrow(main_dataset)) {
  
  if (i == 1) {
    multiplier <- 1
  } 
  else {
    multiplier <- 1 + ((main_dataset$net_productivity[i] -
                        main_dataset$net_productivity[i-1]) / 100)
  }
  
  main_dataset$prod_multiplier[i] <- multiplier
  
}


```

## Create calculations

Issue: We are using the inflation formula, but the data still doesn't seem right.
Things should start at ~$4, I expect it to go up to like $13.

```{r convert-minwage-to-2018-dollars}

# Here, we want to convert all dollar amounts in our dataset to 2018 dollars.
# This will make all the values more readable to our audience.

main_dataset$min_wage_2018_adjusted <- vector("numeric", nrow(main_dataset))

cpi_for_2018 <- main_dataset[[71,2]]

for (i in 1:nrow(main_dataset)) {

  cpi_for_year <- main_dataset$annual_avg_cpi[i]

  # Get previous minimum wage value, which we will then multiply
  # by the inflation percentage between the two years.
  base_min_wage_for_year <- ifelse(i == 1,
                                   main_dataset$raw_min_wage[i],
                                   main_dataset$min_wage_2018_adjusted[i-1])
  
  
  if (i == 1) {
  # We use the formula to get inflation and turn it into a decimal.
  # Formula: (CPIx+1 â€“ CPIx ) / CPIx, where:
  # CPIx is Consumer Price Index of Initial Year
  
  inflation_rate <- ((cpi_for_2018 - cpi_for_year) / cpi_for_year)
  
  # Multiply the base minimum wage rate (what it was in previous year) by
  # the inflation rate to get an inflation-adjusted value.
  main_dataset$min_wage_2018_adjusted[i] <- inflation_rate * base_min_wage_for_year
  } else {
  
    perc_cpi_increase_year_over_year <- cpi_for_year /
      main_dataset$annual_avg_cpi[i - 1]
    
    main_dataset$min_wage_2018_adjusted[i] <- perc_cpi_increase_year_over_year *
      base_min_wage_for_year
    
  }
}

```

```{r calculate-purchasing-power}

# calculate purchasing power
main_dataset$cpi_change_from2018 <- (main_dataset$annual_avg_cpi / cpi_for_2018) * 100
# 1 dollar today = 10 cents in 1948
# money in 1948 had 90% less purchasing power

#applying purchasing power
main_dataset$minwage_purchasingpower <- (cpi_for_2018 / main_dataset$annual_avg_cpi) * main_dataset$raw_min_wage
# minimum wage was the highest as far as purchasing power goes in the 1970's at ~$10. 

```



```{r calculate_productivity-minwage}

# Now that minimum wage is in 2018 dollars, we multiple it by raw percentages
# to get the productivity-and-inflation-based minimum wage. All is in 2018
# dollars.

main_dataset$min_wage_prod_adjusted <- vector("numeric", nrow(main_dataset))

for (i in 1:nrow(main_dataset)) {

  base_amount <- ifelse(i==1, 
                        main_dataset$min_wage_2018_adjusted[1],
                        main_dataset$min_wage_prod_adjusted[i-1])
  
  main_dataset$min_wage_prod_adjusted[i] <- 
    base_amount * main_dataset$prod_multiplier[i]
  
}

```


## Graph


```{r update-dataset-only-necessary-columns}

# Maybe here, we can remove unnecessary stuff

main_dataset_final <- 
  main_dataset %>%
  select(year, raw_min_wage, min_wage_2018_adjusted, min_wage_prod_adjusted, minwage_purchasingpower) %>% 
  pivot_longer(cols = c(raw_min_wage, 
                        min_wage_2018_adjusted,
                        min_wage_prod_adjusted,
                        minwage_purchasingpower),
               names_to = "Type",
               values_to = "Dollars")

```


Create a theme
```{r create-theme}
wage_theme <-
  theme_minimal() + 
  theme(
    text = element_text(family = "Georgia"), 
    plot.title = element_text(face = "bold", size = 16, color = "seagreen"), 
    plot.subtitle = element_text(face = "italic", size = 14, color = "royalblue4"), 
    axis.title = element_text(size = 14, face = "bold", color = "seagreen"), 
    axis.text = element_text(size = 12, color = "navyblue"), 
    axis.line = element_blank(), 
    axis.ticks = element_blank(), 
    axis.text.x = element_text(angle = 90), 
    legend.title = element_text(size = 12, face = "bold", color = "seagreen"), 
    legend.text = element_text(size = 12, color = "navyblue")) 
```

```{r}
main_dataset$wage_change <- vector("numeric", 71)

for (i in seq(nrow(main_dataset))) {
  if (i == 1) {
    main_dataset$wage_change[i] <- 0
  } else {
    if (main_dataset$raw_min_wage[i] == main_dataset$raw_min_wage[i - 1]) {
    main_dataset$wage_change[i] <- 0
    } 
    else { 
    main_dataset$wage_change[i] <- 45
    }
  }
}

```

```{r create-graph-comparing-min-wages, warning=FALSE, echo=FALSE, message = FALSE}

wage_values_graph <- 
  ggplot() +
    geom_bar(data = main_dataset, aes(x = year, y = wage_change), alpha = .3, stat = "identity", color = "darkseagreen1") +
  geom_path(data = main_dataset_final, aes(x = year, y = Dollars, color = Type), size = 1.5) +
  labs(title = "$ Disparity in Actual and Calculated \nMinimum Wage over Time",
       y = "Dollars",
       x = "Year",
       caption = "Year when the federal minimum wage change shown in green") +
  scale_color_discrete(name="Minimum Wage",
    breaks=c("raw_min_wage", 
                             "min_wage_2018_adjusted",
                             "min_wage_prod_adjusted",
                             "minwage_purchasingpower"),
    labels=c("2018 Dollars", 
                             "2018 Productivity Adjusted", 
                             "Purchasing Power", 
                             "Raw Value")) +
  wage_theme + 
  theme(plot.title = element_text(hjust = 0.5))

wage_values_graph

```


